---
layout: post
title:  "Unity深度纹理的探索"
date:   2017-02-06
excerpt: "Unity中关于深度纹理的一些基础知识"
tag:
- Unity
comments: true
---
我在实现阴影映射（Shadow Mapping）过程中，因为需要使用摄像机视角的深度纹理以及光源视角的深度纹理，所以查阅了一些关于深度纹理的使用以及实现其可视化的资料，特此记录。

###**什么是深度纹理**
简单而言，深度纹理中存的是一个像素的z值（视锥体近平面与远平面之间的任何值），在此处就表示深度。但是，它的范围是0.0~1.0之间。这个距离是从摄像机为原点计算出来的z的值。然而它实际存储的值是经过mvp矩阵变换之后，即变换到摄像机空间（view space）又经projection矩阵变换(进入剪裁空间，也被称为齐次剪裁空间)之后在经硬件自动除以w（这之后才是真正的投影变换）<font color='red'>*OpenGL中齐次除法之后的范围是-1~1*</font>，最后得到的是归一化的设备坐标（Normalized Device Coordinate，NDC）。然后统一 z * 0.5 + 0.5之后，将范围变换到0~1，诺诺，存的就是此值了。

###**深度纹理精度问题的细节**
由于摄像机常用的far距离有时实在是太远，并且计算机的浮点数的精度限制，当一个很大的距离（例如0~2000）映射到0.0~1.0时，会有很大的误差。所以，就有了一种近处精度较高，远处精度较低的计算方法，参考[OpenGL教程中关于深度测试的一章](http://learnopengl-cn.readthedocs.io/zh/latest/04%20Advanced%20OpenGL/01%20Depth%20testing/)。

###**Unity中实现深度纹理的可视化**
Unity中封装了各种现成的函数供我们使用，尤其是着色器中的一些计算方法，虽然代码简单，但是值得摸索的东西还有很多。
实现思路如下：告诉Camera，本次渲染要渲染深度纹理，然后在Shader中使用Unity提供的纹理以及函数等实现深度纹理的可视化。下面先贴出脚本以及Shader的代码。

* 1.脚本通知Camera绘制深度纹理，代码如下。
{% highlight c# %}
using UnityEngine;
using System.Collections;

[ExecuteInEditMode]
[RequireComponent(typeof(Camera))]
public class ShowDepth : MonoBehaviour {

	public Material mat;

	void Start () {
		Camera.main.depthTextureMode = DepthTextureMode.Depth;
	}

	// Called by the camera to apply the image effect
	void OnRenderImage (RenderTexture source, RenderTexture destination){
		//mat is the material containing your shader
		Graphics.Blit(source,destination,mat);
	}
}
{% endhighlight %}  



